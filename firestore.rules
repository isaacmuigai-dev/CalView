rules_version = '2';

/**
 * CalView Firestore Security Rules
 * --------------------------------
 * This file contains the combined security logic for:
 * 1. User Profiles & Daily Logs
 * 2. Feature Requests & Comments
 * 3. Social Challenges & Leaderboards
 * 4. Production-Scale Groups & Social Interactions (Likes, Replies, Presence)
 */

service cloud.firestore {
  match /databases/{database}/documents {
    
    // ==========================================
    // üõ†Ô∏è HELPER FUNCTIONS
    // ==========================================
    
    // Check if the request is from a logged-in user
    function isAuthenticated() {
      return request.auth != null;
    }
    


    // ==========================================
    // üë§ USER DATA & LOGS
    // ==========================================

    // Users collection - Users can only access their own data
    match /users/{userId} {
      allow read, write: if isAuthenticated() && request.auth.uid == userId;
      
      // All sub-collections (meals, dailyLogs, fasting_sessions, etc.)
      match /{allSubcollections=**} {
        allow read, write: if isAuthenticated() && request.auth.uid == userId;
      }
    }

    // ==========================================
    // üí° FEEDBACK & IMPROVEMENTS
    // ==========================================

    // Feature Requests - Authenticated users can interact
    match /feature_requests/{requestId} {
      allow read, create, update: if isAuthenticated();
      
      // Comments under feature requests
      match /comments/{commentId} {
        allow read, create, update: if isAuthenticated();
      }
    }

    // ==========================================
    // üèÜ SOCIAL CHALLENGES
    // ==========================================

    // Social Challenges - Read/Post for all, Update for creators
    match /social_challenges/{challengeId} {
      allow read, create: if isAuthenticated();
      allow update: if isAuthenticated() && resource.data.creatorId == request.auth.uid;
    }
    
    // Challenge Participants - Participant-specific access
    match /challenge_participants/{participantId} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && request.auth.uid == participantId.split('_')[1];
    }


